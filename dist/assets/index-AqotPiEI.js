var w=Object.defineProperty;var P=(h,s,t)=>s in h?w(h,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[s]=t;var b=(h,s,t)=>(P(h,typeof s!="symbol"?s+"":s,t),t);import{H as O,k as d,g as o,d as S,l as F,_ as A,s as I,b as U,n as z,R as D,A as k,h as H,F as W,S as V}from"./index-iGRhHhaY.js";import{H as Y}from"./harvest-scheduler-2-eCNpfP.js";import{M as e,a as g,b as x}from"./session-entity-L9wlHB7X.js";import{A as G,o as j}from"./aggregate-base-rpFAq55Q.js";import{s as q}from"./shared-channel-eZ_QJilv.js";import"./invoke-yZTpZaXg.js";const K=.12,c={DomContentLoaded:0,Load:1,FullSnapshot:2,IncrementalSnapshot:3,Meta:4,Custom:5},m={RESET:{message:"Session was reset",sm:"Reset"},IMPORT:{message:"Recorder failed to import",sm:"Import"},TOO_MANY:{message:"429: Too Many Requests",sm:"Too-Many"},TOO_BIG:{message:"Payload was too large",sm:"Too-Big"},CROSS_TAB:{message:"Session Entity was set to OFF on another tab",sm:"Cross-Tab"}};let r,C,B;const Z=1e6,Q=64e3,N=5e3,X={[e.ERROR]:15e3,[e.FULL]:3e5,[e.OFF]:0};class J extends G{constructor(s,t){super(s,t,O),this.events=[],this.backloggedEvents=[],this.harvestTimeSeconds=d(this.agentIdentifier,"session_replay.harvestTimeSeconds")||60,this.initialized=!1,this.errorNoticed=!1,this.mode=e.OFF,this.blocked=!1,this.recording=!1,this.shouldCompress=!0,this.hasSnapshot=!1,this.hasMeta=!1,this.hasError=!1,this.cycleTimestamp=void 0,this.payloadBytesEstimation=0,this.lastMeta=void 0,this.entitled=!1;const n=d(s,"privacy.cookies_enabled")===!0&&d(s,"session_trace.enabled")===!0;this.stopRecording=()=>{},n&&(this.ee.on(g.RESET,()=>{this.abort(m.RESET)}),this.ee.on(g.PAUSE,()=>{this.stopRecording()}),this.ee.on(g.RESUME,()=>{const{session:i}=o(this.agentIdentifier);this.mode=i.state.sessionReplayMode,!(!this.initialized||this.mode===e.OFF)&&this.startRecording()}),this.ee.on(g.UPDATE,(i,a)=>{!this.initialized||this.blocked||i!==x.CROSS_TAB||(this.mode!==e.OFF&&a.sessionReplayMode===e.OFF&&this.abort(m.CROSS_TAB),this.mode=a.sessionReplay)}),this.scheduler=new Y("browser/blobs",{onFinished:this.onHarvestFinished.bind(this),retryDelay:this.harvestTimeSeconds,getPayload:this.prepareHarvest.bind(this),raw:!0},this),S("recordReplay",()=>{this.blocked||!this.entitled||(r?this.mode!==e.FULL&&this.switchToFull():this.initializeRecording(!1,!0,!0))},this.featureName,this.ee),S("pauseReplay",()=>{this.forceStop(this.mode!==e.ERROR)},this.featureName,this.ee),S("errorAgg",i=>{var a;this.hasError=!0,this.errorNoticed=!0,this.mode===e.ERROR&&((a=F)==null?void 0:a.document.visibilityState)==="visible"&&this.switchToFull()},this.featureName,this.ee),this.waitForFlags(["sr"]).then(i=>{let[a]=i;this.entitled=a,this.initializeRecording(Math.random()*100<d(this.agentIdentifier,"session_replay.error_sampling_rate"),Math.random()*100<d(this.agentIdentifier,"session_replay.sampling_rate"))}).then(()=>q.onReplayReady(this.mode)),this.drain())}switchToFull(){this.mode=e.FULL,r&&this.initialized&&(this.stopRecording(),this.startRecording(),this.scheduler.startTimer(this.harvestTimeSeconds),this.syncWithSessionManager({sessionReplayMode:this.mode}))}async initializeRecording(s,t,n){if(this.initialized=!0,!this.entitled||this.recording)return;const{session:i}=o(this.agentIdentifier);if(!i.isNew&&!n)this.mode=i.state.sessionReplayMode;else if(t)this.mode=e.FULL;else if(s)this.mode=e.ERROR;else return;this.mode===e.ERROR&&this.errorNoticed&&(this.mode=e.FULL);try{r=(await A(()=>import("./all-CdJYeqYb.js"),__vite__mapDeps([]))).record}catch{return this.abort(m.IMPORT)}this.mode===e.FULL&&this.scheduler.startTimer(this.harvestTimeSeconds);try{const{gzipSync:a,strToU8:l}=await A(()=>import("./browser-T1c8_RDq.js"),__vite__mapDeps([]));C=a,B=l}catch{this.shouldCompress=!1}this.startRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})}prepareHarvest(){if(this.events.length===0||this.mode!==e.FULL&&!this.blocked)return;const s=this.getHarvestContents();if(!s.body.length){this.clearBuffer();return}this.shouldCompress?(s.body=C(B(I(s.body))),this.scheduler.opts.gzip=!0):this.scheduler.opts.gzip=!1;const{session:t}=o(this.agentIdentifier);return t.state.sessionReplaySentFirstChunk||this.syncWithSessionManager({sessionReplaySentFirstChunk:!0}),this.clearBuffer(),[s]}getHarvestContents(){var E,_,T,v,M;const s=o(this.agentIdentifier),t=U(this.agentIdentifier),n=(E=t.jsAttributes)==null?void 0:E["enduser.id"];this.backloggedEvents.length&&(this.events=[...this.backloggedEvents,...this.events]),((_=this.events[0])==null?void 0:_.type)===c.FullSnapshot&&this.lastMeta&&(this.hasMeta=!0,this.events.unshift(this.lastMeta),this.lastMeta=void 0),((T=this.events[this.events.length-1])==null?void 0:T.type)===c.Meta&&(this.lastMeta=this.events[this.events.length-1],this.events=this.events.slice(0,this.events.length-1),this.hasMeta=!!this.events.find(L=>L.type===c.Meta));const l=o(this.agentIdentifier).offset,u=z(),R=(v=this.events[0])==null?void 0:v.timestamp,y=(M=this.events[this.events.length-1])==null?void 0:M.timestamp,p=R||this.cycleTimestamp,f=y||l+u;return{qs:{browser_monitoring_key:t.licenseKey,type:"SessionReplay",app_id:t.applicationID,protocol_version:"0",attributes:j({...this.shouldCompress&&{content_encoding:"gzip"},"replay.firstTimestamp":p,"replay.firstTimestampOffset":p-l,"replay.lastTimestamp":f,"replay.durationMs":f-p,"replay.nodes":this.events.length,"session.durationMs":s.session.getDuration(),agentVersion:s.version,session:s.session.state.value,rst:u,hasMeta:this.hasMeta,hasSnapshot:this.hasSnapshot,hasError:this.hasError,isFirstChunk:s.session.state.sessionReplaySentFirstChunk===!1,decompressedBytes:this.payloadBytesEstimation,"rrweb.version":D,...n&&{"enduser.id":n}},N).substring(1)},body:this.events}}onHarvestFinished(s){s.status===429&&this.abort(m.TOO_MANY),this.blocked&&this.scheduler.stopTimer(!0)}clearBuffer(){this.mode===e.ERROR?this.backloggedEvents=this.events:this.backloggedEvents=[],this.events=[],this.hasSnapshot=!1,this.hasMeta=!1,this.hasError=!1,this.payloadBytesEstimation=0,this.clearTimestamps()}startRecording(){if(!r)return k("Recording library was never imported"),this.abort(m.IMPORT);this.recording=!0;const{block_class:s,ignore_class:t,mask_text_class:n,block_selector:i,mask_input_options:a,mask_text_selector:l,mask_all_inputs:u,inline_images:R,inline_stylesheet:y,collect_fonts:p}=d(this.agentIdentifier,"session_replay"),f=r({emit:this.store.bind(this),blockClass:s,ignoreClass:t,maskTextClass:n,blockSelector:i,maskInputOptions:a,maskTextSelector:l,maskAllInputs:u,inlineImages:R,inlineStylesheet:y,collectFonts:p,checkoutEveryNms:X[this.mode]});this.stopRecording=()=>{this.recording=!1,f()}}store(s,t){if(this.setTimestamps(),this.blocked)return;const n=I(s).length,i=this.getPayloadSize(n);if(i>Z)return this.clearBuffer(),this.abort(m.TOO_BIG);this.mode===e.ERROR&&t&&s.type===c.Meta&&this.clearBuffer(),s.type===c.Meta&&(this.hasMeta=!0),s.type===c.FullSnapshot&&(this.hasSnapshot=!0),this.events.push(s),this.payloadBytesEstimation+=n,i>Q&&this.mode!==e.ERROR&&this.scheduler.runHarvest()}takeFullSnapshot(){r&&r.takeFullSnapshot()}setTimestamps(){this.cycleTimestamp||(this.cycleTimestamp=o(this.agentIdentifier).offset+F.performance.now())}clearTimestamps(){this.cycleTimestamp=void 0}getPayloadSize(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;return this.estimateCompression(this.payloadBytesEstimation+s)+N}forceStop(s){s&&this.scheduler.runHarvest(),this.mode=e.OFF,this.stopRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode})}abort(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};k("SR aborted -- ".concat(s.message)),H(V,["SessionReplay/Abort/".concat(s.sm)],void 0,W.metrics,this.ee),this.blocked=!0,this.mode=e.OFF,this.stopRecording(),this.syncWithSessionManager({sessionReplayMode:this.mode}),this.clearTimestamps(),this.ee.emit("REPLAY_ABORTED")}estimateCompression(s){return this.shouldCompress?s*K:s}syncWithSessionManager(){let s=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const{session:t}=o(this.agentIdentifier);t.write(s)}}b(J,"featureName",O);export{K as AVG_COMPRESSION,J as Aggregate,Q as IDEAL_PAYLOAD_SIZE,Z as MAX_PAYLOAD_SIZE,c as RRWEB_EVENT_TYPES};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}