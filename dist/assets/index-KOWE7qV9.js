var X=Object.defineProperty;var z=(t,r,n)=>r in t?X(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n;var G=(t,r,n)=>(z(t,typeof r!="symbol"?r+"":r,n),n);import{f as Q,a as P,d as Y,g as k,b as O,s as E,h as v,F as x,S}from"./index-iGRhHhaY.js";import{g as J,n as p,a as b,b as V}from"./bel-serializer-yzeKuBDE.js";import{H as Z}from"./harvest-scheduler-2-eCNpfP.js";import{s as K,a as W}from"./deny-list-FANH1bjH.js";import{A as $}from"./aggregate-base-rpFAq55Q.js";import"./session-entity-L9wlHB7X.js";import"./invoke-yZTpZaXg.js";function ee(t){return(t==null?void 0:t.constructor)==={}.constructor}function te(){let{body:t,query:r}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};if(!(!t&&!r))try{const n=re(w(t));if(n)return n;const o=R(se(r));if(o)return o}catch{}}function R(t){if(typeof t!="object"||!t.query||typeof t.query!="string")return;const r=t.query.trim().match(/^(query|mutation|subscription)\s?(\w*)/),n=r==null?void 0:r[1];return n?{operationName:t.operationName||(r==null?void 0:r[2])||"Anonymous",operationType:n,operationFramework:"GraphQL"}:void 0}function re(t){if(!t)return;Array.isArray(t)||(t=[t]);const r=[],n=[];for(let o of t){const m=R(o);m&&(r.push(m.operationName),n.push(m.operationType))}if(n.length)return{operationName:r.join(","),operationType:n.join(","),operationFramework:"GraphQL"}}function w(t){let r;if(!t||typeof t!="string"&&typeof t!="object"||(typeof t=="string"?r=JSON.parse(t):r=t,!ee(r)&&!Array.isArray(r)))return;let n=!1;if(Array.isArray(r)?n=r.some(o=>F(o)):n=F(r),!!n)return r}function se(t){if(!t||typeof t!="string")return;const r=new URLSearchParams(t);return w(Object.fromEntries(r))}function F(t){return!(typeof t!="object"||!t.query||typeof t.query!="string")}class ae extends ${constructor(r,n){super(r,n,Q);const o=P(r),m=o.ajax.enabled!==!1;if(Y("xhr",L,this.featureName,this.ee),!m){this.drain();return}const H=k(r).denyList;K(H);let c=[],l={},A=[];const y=this.ee,I=o.ajax.harvestTimeSeconds||10,T=o.ajax.maxPayloadSize||1e6;this.storeXhr=L,this.prepareHarvest=N,this.getStoredEvents=function(){return{ajaxEvents:c,spaAjaxEvents:l}},y.on("interactionSaved",e=>{l[e.id]&&delete l[e.id]}),y.on("interactionDiscarded",e=>{l[e.id]&&(l[e.id].forEach(function(a){c.push(a)}),delete l[e.id])});const _=new Z("events",{onFinished:D,getPayload:N},this);y.on("drain-".concat(this.featureName),()=>{_.startTimer(I)}),this.drain();const C=O(r).errorBeacon,j=o.proxy.beacon;function L(e,a,s,i,f){var B;a.time=s;var u;if(e.cat?u=E([e.status,e.cat]):u=E([e.status,e.host,e.pathname]),n.store("xhr",u,e,a),!!m){if(!W(e)){e.hostname===C||j&&e.hostname===j?v(S,["Ajax/Events/Excluded/Agent"],void 0,x.metrics,y):v(S,["Ajax/Events/Excluded/App"],void 0,x.metrics,y);return}v("bstXhrAgg",["xhr",u,e,a],void 0,x.sessionTrace,y);var h=this,d={method:e.method,status:e.status,domain:e.host,path:e.pathname,requestSize:a.txSize,responseSize:a.rxSize,type:f,startTime:s,endTime:i,callbackDuration:a.cbTime};if(h.dt&&(d.spanId=h.dt.spanId,d.traceId=h.dt.traceId,d.spanTimestamp=h.dt.timestamp),d.gql=e.gql=te({body:this.body,query:(B=this==null?void 0:this.parsedOrigin)==null?void 0:B.search}),d.gql&&v(S,["Ajax/Events/GraphQL/Bytes-Added",E(d.gql).length],void 0,x.metrics,y),this.spaNode){var g=this.spaNode.interaction.id;l[g]=l[g]||[],l[g].push(d)}else c.push(d)}}function N(e){if(e=e||{},c.length===0)return null;for(var a=q(c,e.maxPayloadSize||T),s=[],i=0;i<a.length;i++)s.push({body:{e:a[i]}});return e.retry&&(A=c.slice()),c=[],s}function q(e,a,s){s=s||1;for(var i=[],f=e.length/s,u=M(e,f),h=!1,d=0;d<u.length;d++){var g=u[d];if(g.tooBig(a)){if(g.events.length!==1){h=!0;break}}else i.push(g.payload)}return h?q(e,a,++s):i}function D(e){e.retry&&A.length>0&&(c.unshift(...A),A=[])}function M(e,a){a=a||e.length;for(var s=[],i=0,f=e.length;i<f;i+=a)s.push(new U(e.slice(i,i+a)));return s}function U(e){this.addString=J(r),this.events=e,this.payload="bel.7;";for(var a=0;a<e.length;a++){var s=e[a],i=[p(s.startTime),p(s.endTime-s.startTime),p(0),p(0),this.addString(s.method),p(s.status),this.addString(s.domain),this.addString(s.path),p(s.requestSize),p(s.responseSize),s.type==="fetch"?1:"",this.addString(0),b(s.spanId,this.addString,!0)+b(s.traceId,this.addString,!0)+b(s.spanTimestamp,p,!1)],f="2,",u=V({...O(r).jsAttributes||{},...s.gql||{}},this.addString);i.unshift(p(u.length)),f+=i.join(","),u&&u.length>0&&(f+=";"+u.join(";")),a+1<e.length&&(f+=";"),this.payload+=f}this.tooBig=function(h){return h=h||T,this.payload.length*2>h}}}}G(ae,"featureName",Q);export{ae as Aggregate};
