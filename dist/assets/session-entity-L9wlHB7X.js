import{o,U as E,c as g,V as p,w as S,W as A,X as w,Y as y,Z as u,$ as M,A as l,s as T,h as v,F as b,S as x}from"./index-iGRhHhaY.js";import{d as R}from"./invoke-yZTpZaXg.js";class m{constructor(e,t){if(!e.onEnd)throw new Error("onEnd handler is required");if(!t)throw new Error("ms duration is required");this.onEnd=e.onEnd,this.initialMs=t,this.startTimestamp=Date.now(),this.timer=this.create(this.onEnd,t)}create(e,t){return this.timer&&this.clear(),setTimeout(()=>e?e():this.onEnd(),t||this.initialMs)}clear(){clearTimeout(this.timer),this.timer=null}end(){this.clear(),this.onEnd()}isValid(){return this.initialMs-(Date.now()-this.startTimestamp)>0}}class I extends m{constructor(e,t){var s;super(e,t),this.onPause=typeof e.onPause=="function"?e.onPause:()=>{},this.onRefresh=typeof e.onRefresh=="function"?e.onRefresh:()=>{},this.onResume=typeof e.onResume=="function"?e.onResume:()=>{},this.remainingMs=void 0,e.refreshEvents||(e.refreshEvents=["click","keydown","scroll"]);try{this.abortController=new AbortController}catch{}if(o&&e.ee){if(e.ee){this.ee=e.ee;const r=R(this.refresh.bind(this),500,{leading:!0});this.refreshHandler=i=>{var a;e.refreshEvents.includes((a=i==null?void 0:i[0])==null?void 0:a.type)&&r()},e.ee.on("fn-end",this.refreshHandler)}E(r=>{r==="hidden"?this.pause():this.resume()},!1,!1,(s=this.abortController)==null?void 0:s.signal)}}abort(){var e;this.clear(),(e=this.abortController)==null||e.abort(),this.refreshHandler&&(this.ee.removeEventListener("fn-end",this.refreshHandler),this.refreshHandler=this.ee=null)}pause(){this.onPause(),clearTimeout(this.timer),this.remainingMs=this.initialMs-(Date.now()-this.startTimestamp)}resume(){this.refresh(),this.onResume()}refresh(e,t){this.clear(),this.timer=this.create(e,t),this.startTimestamp=Date.now(),this.remainingMs=void 0,this.onRefresh()}}const d={OFF:0,FULL:1,ERROR:2},h={value:"",inactiveAt:0,expiresAt:0,updatedAt:Date.now(),sessionReplayMode:d.OFF,sessionReplaySentFirstChunk:!1,sessionTraceMode:d.OFF,traceHarvestStarted:!1,custom:{}},n={PAUSE:"session-pause",RESET:"session-reset",RESUME:"session-resume",UPDATE:"session-update"},f={SAME_TAB:"same-tab",CROSS_TAB:"cross-tab"};class F{constructor(e){const{agentIdentifier:t,key:s,storage:r}=e;if(!t||!s||!r)throw new Error("Missing required field(s):".concat(t?"":" agentID").concat(s?"":" key").concat(r?"":" storage"));this.agentIdentifier=t,this.storage=r,this.state={},this.key=s,this.ee=g.get(t),p(this.ee),this.setup(e),o&&S("storage",i=>{if(i.key===this.lookupKey){const a=typeof i.newValue=="string"?JSON.parse(i.newValue):i.newValue;this.sync(a),this.ee.emit(n.UPDATE,[f.CROSS_TAB,this.state])}})}setup(e){let{value:t=A(16),expiresMs:s=w,inactiveMs:r=y}=e;this.state={},this.sync(h),this.state.value=t,this.expiresMs=s,this.inactiveMs=r;const i=this.read();s?(this.state.expiresAt=(i==null?void 0:i.expiresAt)||this.getFutureTimestamp(s),this.expiresTimer=new m({onEnd:()=>{this.collectSM("expired"),this.collectSM("duration"),this.reset()}},this.state.expiresAt-Date.now())):this.state.expiresAt=1/0,r?(this.state.inactiveAt=(i==null?void 0:i.inactiveAt)||this.getFutureTimestamp(r),this.inactiveTimer=new I({onEnd:()=>{this.collectSM("inactive"),this.collectSM("duration"),this.reset()},onRefresh:this.refresh.bind(this),onResume:()=>{this.ee.emit(n.RESUME)},onPause:()=>{this.initialized&&this.ee.emit(n.PAUSE),this.write(u(this.state,h))},ee:this.ee,refreshEvents:["click","keydown","scroll"]},this.state.inactiveAt-Date.now())):this.state.inactiveAt=1/0,this.isNew=!Object.keys(i).length,this.isNew?this.write(u(this.state,h),!0):this.sync(i),this.initialized=!0}get lookupKey(){return"".concat(M,"_").concat(this.key)}sync(e){Object.assign(this.state,e)}read(){try{const e=this.storage.get(this.lookupKey);if(!e)return{};const t=typeof e=="string"?JSON.parse(e):e;return this.isInvalid(t)?{}:this.isExpired(t.expiresAt)?(this.collectSM("expired"),this.collectSM("duration",t,!0),this.reset()):this.isExpired(t.inactiveAt)?(this.collectSM("inactive"),this.collectSM("duration",t,!0),this.reset()):t}catch(e){return l("Failed to read from storage API",e),{}}}write(e){try{return!e||typeof e!="object"?void 0:(e.updatedAt=Date.now(),this.sync(e),this.storage.set(this.lookupKey,T(this.state)),this.ee.emit(n.UPDATE,[f.SAME_TAB,this.state]),e)}catch(t){return l("Failed to write to the storage API",t),null}}reset(){var e,t,s,r;try{return this.initialized&&this.ee.emit(n.RESET),this.storage.remove(this.lookupKey),(t=(e=this.inactiveTimer)==null?void 0:e.abort)==null||t.call(e),(r=(s=this.expiresTimer)==null?void 0:s.clear)==null||r.call(s),delete this.isNew,this.setup({agentIdentifier:this.agentIdentifier,key:this.key,storage:this.storage,expiresMs:this.expiresMs,inactiveMs:this.inactiveMs}),this.read()}catch{return{}}}refresh(){const e=this.read();this.write({...e,inactiveAt:this.getFutureTimestamp(this.inactiveMs)})}isExpired(e){return Date.now()>e}isInvalid(e){return!Object.keys(h).every(s=>Object.keys(e).includes(s))}collectSM(e,t,s){let r,i;e==="duration"&&(r=this.getDuration(t,s),i="Session/Duration/Ms"),e==="expired"&&(i="Session/Expired/Seen"),e==="inactive"&&(i="Session/Inactive/Seen"),i&&v(x,[i,r],void 0,b.metrics,this.ee)}getDuration(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this.state,t=arguments.length>1?arguments[1]:void 0;const s=e.expiresAt-this.expiresMs;return(t?Date.now():e.updatedAt)-s}getFutureTimestamp(e){return Date.now()+e}syncCustomAttribute(e,t){if(o)if(t===null){const s=this.read();s.custom&&(delete s.custom[e],this.write({...s}))}else{const s=this.read();this.custom={...(s==null?void 0:s.custom)||{},[e]:t},this.write({...s,custom:this.custom})}}}export{d as M,F as S,n as a,f as b};
